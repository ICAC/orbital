{% extends 'base.html.twig' %}
{% import ':macro:display.html.twig' as display %}
{% from ':macro:proof.html.twig' import display_proof %}

{% block title %}
    {{ display.person(score.person) }} - {{ display.round(score.round) }}
{% endblock %}

{% block body %}
    {% include ':score:_detail.html.twig' with { 'score': score, 'handicap': handicap } only %}

    {% if score.complete and score.arrows.count() > 0 %}
        <div id="scoring_app"></div>
    {% endif %}

    {% if is_granted('ROLE_ADMIN') %}
        {{ display_proof(score.proof) }}
    {% endif %}
{% endblock %}

{% block sidebar %}
    {% if is_granted_any(['SCORE', 'EDIT', 'ACCEPT', 'ROLE_ADMIN'], score) %}
        <div class="widget">
            <h3 class="widget-title">Actions</h3>
            <ul>
                {% if is_granted('SCORE', score) %}
                    <li><a href="{{ url('score_input', { 'id': score.id }) }}">Input Score</a></li>
                {% endif %}
                {% if is_granted('ACCEPT', score) %}
                    <li><a href="{{ url('score_accept', { 'id': score.id }) }}">Accept</a></li>
                {% endif %}
                {% if is_granted('EDIT', score) %}
                    <li><a href="{{ url('score_edit', { 'id': score.id }) }}">Edit</a></li>
                {% endif %}
                {% if is_granted('ROLE_ADMIN') %}
                    <li><a href="{{ url('score_delete', { 'id': score.id }) }}">Delete</a></li>
                {% endif %}
            </ul>
        </div>
    {% endif %}

    {{ parent() }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% if score.complete and score.arrows.count() > 0 %}
        <script src="{{ socketio_url }}/socket.io/socket.io.js"></script>
        <script src="{{ asset('js/scoring.js') }}"></script>
        <script>
            'use strict';

            (function (app) {
                var round = {{ score.round|json_encode|raw }};
                var score_id = {{ score.id }};

                m.module($("#scoring_app")[0], {
                    controller: function () {
                        var urls = {
                            'socket.io': '{{ socketio_url }}'
                        };

                        app.vm.init(round, score_id, false, urls);
                    },
                    view: app.view
                });
            })(window['orbital']['scoring']);
        </script>
    {% endif %}
{% endblock %}
