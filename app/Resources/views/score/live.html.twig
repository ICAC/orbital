{% extends '::base.html.twig' %}
{% import ':macro:display.html.twig' as display %}

{% block title %}
    Live Scoring for
    {{ display.person(score.person) }}
    {{ display.round(score.round) }}
{% endblock %}

{% block body %}
    <div id="scoring_app"></div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script src="{{ socketio_url }}/socket.io/socket.io.js"></script>
    <script src="{{ asset('js/scoring.js') }}"></script>
    <script>
        'use strict';

        (function (app) {
            var round = {{ score.round|json_encode|raw }};
            var score_id = {{ score.id }};
            var scoring = {{ scoring|default(false) ? 'true' : 'false' }};

            m.module($("#scoring_app")[0], {
                controller: function () {
                    var urls = {
                        'add': '{{ url('score_data_arrows_add', { 'id': score.id }) }}',
                        'amend': '{{ url('score_data_arrows_amend', { 'id': score.id }) }}',
                        'remove': '{{ url('score_data_arrows_remove', { 'id': score.id }) }}',
                        'complete': '{{ url('score_data_complete', { 'id': score.id }) }}',
                        'socket.io': '{{ socketio_url }}'
                    };

                    app.vm.init(round, score_id, scoring, urls);
                },
                view: app.view
            });

            if (scoring) {
                var addArrowToBuffer = function (score) {
                    app.vm.addToBuffer(score);
                };

                window.addEventListener('keydown', function (e) {
                    m.startComputation();

                    if (e.keyCode >= 49 && e.keyCode <= 57) {
                        addArrowToBuffer(e.keyCode - 48);
                    } else if (e.keyCode == 48) {
                        addArrowToBuffer(10);
                    } else if (e.keyCode >= 97 && e.keyCode <= 105) {
                        addArrowToBuffer(e.keyCode - 96);
                    } else if (e.keyCode == 96) {
                        addArrowToBuffer(10);
                    } else if (e.keyCode == 77) {
                        addArrowToBuffer('M');
                    } else if (e.keyCode == 88) {
                        addArrowToBuffer('X');
                    } else if (e.keyCode == 8) {
                        if (app.vm.arrowBuffer.length) {
                            e.preventDefault();

                            app.vm.removeFromBuffer();
                        }
                    } else if (e.keyCode == 13) {
                        if (app.vm.arrowBuffer.length) {
                            app.vm.submitBuffer();
                        }
                    } else {
                        console.log(e.keyCode);
                    }

                    m.endComputation();
                });
            }

        })(window['orbital']['scoring']);
    </script>

{% endblock %}
